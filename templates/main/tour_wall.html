{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}
  Tour wall
{% endblock %}
{% block header %}
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .stories-container {
            overflow-y: auto;
            scrollbar-width: none; /* For Firefox */
            -ms-overflow-style: none; /* For IE and Edge */
        }
        .stories-container::-webkit-scrollbar {
            display: none; /* For Chrome, Safari and Opera */
        }

        @media (max-width: 1023px) {
            .ad-container {
                display: none;
            }
        }
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
{% endblock %}
{% block content %}
    <!-- Main Travel Blog Page -->
    <div class="min-h-screen">
        <!-- Header Section -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                <div class="mb-4">
                    <h1 class="text-3xl font-bold text-gray-900">Travel Stories</h1>
                    <p class="mt-2 text-gray-600">Inspirational travel stories, photos and guides</p>
                </div>
                
                <!-- Search Bar -->
                <form class="relative" method="get" id="tour_search" autocomplete="off">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input name='q' type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search destinations, places or tags..." required>
                    <button type="submit" style="display:none"></button>
                </form>
            </div>
        </header>

        <!-- Main Content with Sidebar -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col lg:flex-row gap-8">
            <!-- Stories Content -->
            <div class="flex-1">
                {% if q %}
                <div class="text-md">
                    Search results for "{{q}}"
                </div>
                {% endif %}
                <!-- Filter Options -->
                <div class="flex flex-wrap items-center justify-between mb-8 gap-4">
                    <div class="flex space-x-2" id="tour-filter-buttons">
                        <button class="px-3 py-1 rounded-full text-sm bg-indigo-600 text-white" data-filter="All">All</button>
                        <button class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm hover:bg-gray-50" data-filter="Mountains">Mountains</button>
                        <button class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm hover:bg-gray-50" data-filter="Beaches">Beaches</button>
                        <button class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm hover:bg-gray-50" data-filter="Forests">Forests</button>
                        <button class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm hover:bg-gray-50" data-filter="Historical">Historical</button>
                    </div>
                   
                    <div class="flex items-center text-sm text-gray-600">
                        <span class="mr-2">Sort by:</span>
                        <select class="border-0 bg-transparent text-indigo-600 focus:ring-0">
                            <option>Latest</option>
                            <option>Popular</option>
                            <option>Most Viewed</option>
                        </select>
                    </div>
                </div>

                <!-- Stories Container with Hidden Scrollbar -->
                <div class="stories-container">
                    <!-- Featured Story -->
                     {% if featured %}
                    <div class="mb-12" id="featured">
                        <a href="{% url "travel:tour_details" featured.slug %}">
                            <div class="relative rounded-xl overflow-hidden h-96">
                                <img src="{{featured.thumbnail.url}}" alt="Featured Tour" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/40 to-transparent flex items-end p-8">
                                    <div>
                                        <span class="inline-block px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full mb-2">Featured</span>
                                        <h2 class="text-3xl font-bold text-white mb-2">{{featured.title}}</h2>
                                        <p class="text-gray-200 mb-4">{{featured.story|striptags|truncatechars:50}}</p>
                                        <div class="flex items-center text-white">
                                            <span class="flex items-center mr-4">
                                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                5 days
                                            </span>
                                            <span class="flex items-center">
                                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                </svg>
                                                Cox's Bazar, Bangladesh
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endif %}

                    <!-- Stories Grid -->
                    <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-8">
                        
                      <!-- dynamically loaded -->

                        
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="loading-spinner"></div>
                </div>
            </div>

            <!-- Right Sidebar with Ads -->
            <div class="lg:w-80 space-y-6">
                <!-- Sticky container for ads -->
                <div class="ad-container space-y-6">
                    <!-- Ad 1 - Travel Booking -->
                    <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                        <div class="text-center mb-3">
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">Sponsored</span>
                        </div>
                        <a href="#" class="block">
                            <img src="https://images.unsplash.com/photo-1520250497591-112f2f40a3f4" alt="Book your next trip" class="w-full h-40 object-cover rounded-lg mb-3">
                            <h4 class="font-bold text-gray-900 mb-1">Book Your Next Adventure</h4>
                            <p class="text-sm text-gray-600 mb-3">Exclusive deals on hotels and flights. Save up to 40%!</p>
                            <button class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">Explore Deals</button>
                        </a>
                    </div>

                    <!-- Ad 2 - Travel Gear -->
                    <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                        <div class="text-center mb-3">
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">Sponsored</span>
                        </div>
                        <a href="#" class="block">
                            <img src="https://images.unsplash.com/photo-1520006403909-838d6b92c22e" alt="Travel gear" class="w-full h-40 object-cover rounded-lg mb-3">
                            <h4 class="font-bold text-gray-900 mb-1">Essential Travel Gear</h4>
                            <p class="text-sm text-gray-600 mb-3">Top-rated backpacks, cameras, and accessories for travelers.</p>
                            <button class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium">Shop Now</button>
                        </a>
                    </div>

                
                </div>
            </div>
        </div>
    </div>

   
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const storiesGrid = document.getElementById('stories-grid');
            const loadingSpinner = document.getElementById('loading-spinner');
            const storiesContainer = document.querySelector('.stories-container');
            const tourSearchForm = document.getElementById('tour_search');
            const searchInput = tourSearchForm.querySelector('input[name="q"]');
            const filterButtons = document.querySelectorAll('#tour-filter-buttons button');
            let content = document.getElementById('content');

            // State variables
            let isLoading = false;
            let currentPage = 0;
            const threshold = 200; // pixels from bottom to trigger load
            let hasMorePages = true; // Track if more pages are available

            // Helper to render stories
            function renderStories(data) {
                if (!data) return;
                data.results.forEach(story => {
                    const tagsHtml = (story.tags || '')
                        .split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag.length > 0)
                        .slice(0, 2)
                        .map(tag => {
                            const colors = [
                                { bg: 'bg-blue-100', text: 'text-blue-800' },
                                { bg: 'bg-green-100', text: 'text-green-800' },
                                { bg: 'bg-yellow-100', text: 'text-yellow-800' },
                                { bg: 'bg-purple-100', text: 'text-purple-800' },
                                { bg: 'bg-red-100', text: 'text-red-800' }
                            ];
                            const randomColor = colors[Math.floor(Math.random() * colors.length)];
                            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${randomColor.bg} ${randomColor.text}">
                                ${tag}
                            </span>`;
                        }).join('');
                    const storyHtml = `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300">
                            <a href="/travel/tour_details/${story.slug}">
                                <div class="relative h-48">
                                    <img src="${story.thumbnail}" alt="Tour Image" class="w-full h-full object-cover">
                                    <div class="absolute top-4 right-4">
                                        <button class="p-2 bg-white/90 rounded-full hover:bg-white transition-colors duration-200">
                                            <svg class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="flex items-center text-sm text-gray-500 mb-2">
                                        <span>${story.author.userprofile.full_name}</span>
                                        <span class="mx-2">â€¢</span>
                                        <span>${story.time_since}</span>
                                    </div>
                                    <h3 class="text-xl font-semibold text-gray-900 mb-2">${story.title}</h3>
                                    <p class="text-gray-600 mb-4 line-clamp-2">${story.desc}</p>
                                    <div class="flex justify-between items-center">
                                        <div class="flex space-x-2">
                                            ${tagsHtml}
                                        </div>
                                        <span class="text-indigo-600 hover:text-indigo-800 font-medium truncate text-ellipsis">Read More</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    `;
                    storiesGrid.insertAdjacentHTML('beforeend', storyHtml);
                });
                currentPage++;
                isLoading = false;
                loadingSpinner.style.display = 'none';
                if (!data.next) {
                    hasMorePages = false;
                }
            }

            // Load stories with optional query
            function loadMoreStories(q = null) {
                if (isLoading || !hasMorePages) return;
                isLoading = true;
                loadingSpinner.style.display = 'block';
                let url = `/travel?page=${currentPage + 1}`;
                if (q) url += `&q=${encodeURIComponent(q)}`;
                fetch(url)
                    .then(response => {
                        if (response.status === 404) {
                            hasMorePages = false;
                            loadingSpinner.style.display = 'none';
                            return null;
                        }
                        return response.json();
                    })
                    .then(renderStories)
                    .catch(() => {
                        isLoading = false;
                        loadingSpinner.style.display = 'none';
                        hasMorePages = false;
                    });
            }

            // Search form submit
            tourSearchForm.addEventListener("submit", function(e) {
                e.preventDefault();
                const query = searchInput.value.trim();
                currentPage = 0;
                hasMorePages = true;
                storiesGrid.innerHTML = '';
                const featured = document.getElementById('featured');
                if (featured) featured.style.display = 'none';
                loadMoreStories(query);
            });

            // Filter buttons
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('bg-white', 'border', 'border-gray-300', 'text-sm', 'hover:bg-gray-50');
                    });
                    // Add active class to clicked button
                    this.classList.add('bg-indigo-600', 'text-white');
                    this.classList.remove('bg-white', 'border', 'border-gray-300', 'hover:bg-gray-50');
                    // Set q value and trigger submit event programmatically
                    const filterValue = this.getAttribute('data-filter');
                    searchInput.value = filterValue;
                    if (filterValue === 'All') {
                        currentPage = 0;
                        hasMorePages = true;
                        storiesGrid.innerHTML = '';
                        searchInput.value = '';
                        const featured = document.getElementById('featured');
                        if (featured) featured.style.display = '';
                        loadMoreStories();
                    } else {
                        const event = new Event('submit', { bubbles: true, cancelable: true });
                        tourSearchForm.dispatchEvent(event);
                    }
                });
            });

            // Infinite scroll
            content.addEventListener('scroll', function() {
                const scrollTop = content.scrollTop;
                const scrollHeight = content.scrollHeight;
                const clientHeight = content.clientHeight;
                if (scrollHeight - (scrollTop + clientHeight) < threshold) {
                    // If searching, use query; else, load normally
                    const q = searchInput.value.trim();
                    if (q && q !== 'All') {
                        loadMoreStories(q);
                    } else {
                        loadMoreStories();
                    }
                }
            });

            // Initial load
            loadMoreStories();
        });
    </script>
    <script>
        let halfMenu = false;
        let fullMenuHide = true;
        const sideBar = document.getElementById('sidebar')
        const cardGrid = document.getElementById('content')
        sideBar.classList.toggle('md:translate-x-0')
        cardGrid.classList.remove('md:ml-64')
        document.getElementById('default-search').style.display='none';
    </script>
{% endblock %}